<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arkibo Arcade</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --cream: #fffdf2;
      --green-1: #2e7d32;
      --green-2: #81c784;
      --accent: #cfe9d3;
      --card: #ffffff;
      --chess-light: #f0d9b5;
      --chess-dark: #b58863;
    }

    * {box-sizing: border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background: linear-gradient(180deg, #f8fff5 0%, #fffef8 100%);
      color: var(--green-1);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-transform:uppercase;
    }

    .app {
      width:100%;
      max-width:420px;
      background: var(--card);
      border-radius:18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      padding:16px;
      position:relative;
      min-height: 600px;
      overflow: hidden;
    }

    .logo {
      display:block;
      margin:8px auto 6px auto;
      width:100px;
      height:100px;
      object-fit:cover;
      border-radius:20px;
      border:6px solid rgba(255,255,255,0.6);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    h1, h2 {
      font-weight:700;
      letter-spacing:1px;
      margin:6px 0 12px 0;
      font-size:18px;
      text-align:center;
    }

    .menu-buttons {
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px 8px 18px 8px;
    }

    .btn {
      border: none;
      background: linear-gradient(180deg, var(--green-2), #9ccc65);
      color: #053608;
      padding:14px;
      border-radius:12px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      text-decoration: none;
      text-align: center;
    }
    .btn.ghost {
      background: transparent;
      border:2px solid var(--green-2);
      color: var(--green-1);
    }

    /* screens */
    .screen { display:none; padding:8px; }
    .screen.active { display:block; }

    .top-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }

    .icon-large {
      width:72px;
      height:72px;
      object-fit:cover;
      border-radius:20px;
      border:6px solid rgba(255,255,255,0.6);
    }

    .icon-medium {
      width:56px;
      height:56px;
      object-fit:cover;
      border-radius:16px;
    }

    .small { font-size:11px; opacity:0.85; }

    /* Quiz layout */
    .quiz-card {
      background: var(--accent);
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
    }
    .question { font-size:13px; margin-bottom:8px; min-height:44px; }
    .choices { display:flex; flex-direction:column; gap:8px; }
    .choice-btn {
      background:white;
      border-radius:10px;
      padding:10px;
      border:1px solid rgba(0,0,0,0.06);
      font-weight:600;
      cursor:pointer;
    }
    input[type="text"].answer-typed {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.08);
      font-weight:600;
    }

    .controls { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .small-btn {
      padding:8px 10px;
      border-radius:10px;
      border:none;
      background:var(--green-2);
      color:#053608;
      font-weight:700;
      cursor:pointer;
    }

    /* Chess Styles */
    #chess-board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      width: 100%;
      aspect-ratio: 1/1;
      border: 4px solid var(--green-1);
      border-radius: 4px;
      margin-top: 10px;
      touch-action: none;
    }
    .chess-square {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
      user-select: none;
    }
    .chess-square.light { background: var(--chess-light); }
    .chess-square.dark { background: var(--chess-dark); }
    .chess-square.selected { background: #f7e365 !important; }
    .chess-square.valid-move::after {
      content: '';
      width: 12px;
      height: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 50%;
    }

    /* Tic Tac Toe */
    .ttt-board {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      max-width:300px;
      margin:8px auto;
    }
    .ttt-cell {
      background: var(--accent);
      height:80px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      font-weight:800;
      border-radius:10px;
      cursor:pointer;
    }

    /* Match-Kibo Styles */
    .match-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .match-card {
      height: 70px;
      background: var(--green-2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      color: transparent;
      transition: background 0.3s;
    }
    .match-card.flipped {
      background: var(--accent);
      color: var(--green-1);
    }
    .match-card.matched {
      background: #e0e0e0;
      color: #999;
      cursor: default;
    }

    /* Star Clicker Styles */
    #clicker-area {
      width: 100%;
      height: 300px;
      background: #f0fdf4;
      border: 2px dashed var(--green-2);
      position: relative;
      margin-top: 10px;
      border-radius: 12px;
      overflow: hidden;
    }
    #target-star {
      position: absolute;
      font-size: 30px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s;
    }

    /* Leaderboard Table */
    .lb-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    .lb-table th {
      background: var(--green-1);
      color: white;
      padding: 8px;
      text-align: left;
    }
    .lb-table td {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .my-row { background: #fffde7; font-weight: bold; }

    .word-display { font-size:18px; font-weight:800; margin:8px 0; min-height:30px; }
    .center { text-align:center; }
  </style>
</head>
<body>

  <div class="app" id="app">
    
    <div id="auth-screen" class="screen">
      <img class="logo" src="https://i.imgur.com/gguUeAe.png" alt="Logo" />
      <h1>IDENTIFY YOURSELF</h1>
      <p class="center small">Enter a username to track your Star Points.</p>
      <div class="menu-buttons">
        <input type="text" id="username-input" class="answer-typed" placeholder="Username..." style="text-align:center">
        <button class="btn" id="save-user">START ADVENTURE</button>
      </div>
    </div>

    <div id="menu" class="screen">
      <img class="logo" src="https://i.imgur.com/gguUeAe.png" alt="Logo" />
      <h1>ARKIBO ARCADE</h1>
      <div class="center small" style="margin-bottom:15px;">
        PLAYER: <span id="display-name">...</span> | POINTS: <span id="display-points">0</span>
      </div>

      <div class="menu-buttons" style="max-height: 350px; overflow-y: auto;">
        <button class="btn" id="to-chess-kibo">KIBO-CHESS</button>
        <button class="btn" id="to-quiz">QUIZME</button>
        <button class="btn" id="to-ttt">TIC-TAC-KIBO</button>
        <button class="btn" id="to-bone">KIBO BONE RUSH</button>
        <button class="btn" id="to-match">MATCH-KIBO</button>
        <button class="btn" id="to-clicker">STAR CLICKER</button>
        <button class="btn ghost" id="to-lb">LEADERBOARD</button>
        <button class="btn ghost" id="logout-btn" style="border-color: #ff8a80; color: #d32f2f; margin-top: 10px;">LOGOUT</button>
      </div>
    </div>

    <div id="chess-kibo-screen" class="screen">
        <div class="top-row">
            <h2 style="margin:0">KIBO-CHESS</h2>
            <button class="small-btn ghost" id="chess-kibo-home">MENU</button>
        </div>
        <div class="quiz-card">
            <div class="center small" id="chess-kibo-status">WHITE'S TURN</div>
            <div id="chess-board"></div>
            <p class="center small" style="margin-top:10px;">Win: 50‚≠ê | Draw: 25‚≠ê</p>
            <div class="center" style="margin-top:10px;">
                <button class="small-btn" id="chess-kibo-reset">RESET GAME</button>
            </div>
        </div>
    </div>

    <div id="match-screen" class="screen">
        <div class="top-row">
            <h2 style="margin:0">MATCH-KIBO</h2>
            <button class="small-btn ghost" id="match-home">MENU</button>
        </div>
        <div class="quiz-card">
            <div class="center small">TIME: <span id="match-timer">120</span>s | MATCHES: <span id="match-count">0</span>/10</div>
            <div class="match-grid" id="match-grid"></div>
            <div class="center" style="margin-top:15px;">
                <button class="small-btn" id="match-start">START GAME</button>
            </div>
        </div>
    </div>

    <div id="clicker-screen" class="screen">
        <div class="top-row">
            <h2 style="margin:0">STAR CLICKER</h2>
            <button class="small-btn ghost" id="clicker-home">MENU</button>
        </div>
        <div class="quiz-card">
            <div class="center small">TIME: <span id="clicker-timer">30</span>s | SCORE: <span id="clicker-score">0</span></div>
            <div id="clicker-area">
                <div id="target-star" style="display:none;">‚≠ê</div>
            </div>
            <div class="center" style="margin-top:15px;">
                <button class="small-btn" id="clicker-start">START CLICKING</button>
            </div>
        </div>
    </div>

    <div id="lb-screen" class="screen">
        <div class="top-row">
            <h2>LIVE RANKINGS</h2>
            <button class="small-btn ghost" id="lb-back">BACK</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="lb-table">
                <thead>
                    <tr>
                        <th>RANK</th>
                        <th>USERNAME</th>
                        <th>STARS</th>
                    </tr>
                </thead>
                <tbody id="lb-body"></tbody>
            </table>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
      <div class="top-row">
        <img src="https://i.imgur.com/gguUeAe.png" class="icon-medium" />
        <div style="flex:1;margin-left:8px;">
          <h2 style="margin:0">QUIZME</h2>
        </div>
        <div style="text-align:right;">
          <div class="small">SCORE</div>
          <div id="quiz-score" style="font-weight:800">0 / 0</div>
        </div>
      </div>
      <div class="quiz-card">
        <div class="question" id="quiz-question">Ready?</div>
        <div style="display:flex;gap:4px;margin-bottom:8px;">
          <button class="small-btn" id="mode-type">TYPE</button>
          <button class="small-btn ghost" id="mode-mc">MC</button>
          <button class="small-btn" id="quiz-start">START</button>
        </div>
        <div id="quiz-interaction"></div>
        <div class="controls">
          <button class="small-btn" id="quiz-next">NEXT</button>
          <button class="small-btn ghost" id="quiz-skip">SKIP</button>
          <button class="small-btn ghost" id="quiz-back">MENU</button>
        </div>
        <div class="score-timer">
          <div class="small">Time: <span id="quiz-timer">05:00</span></div>
        </div>
      </div>
    </div>

    <div id="ttt-screen" class="screen">
      <div class="top-row">
        <img src="https://i.imgur.com/3npgp4h.png" class="icon-large" />
        <h2 style="margin:0">TIC-TAC-KIBO</h2>
        <button class="small-btn" id="ttt-home">MENU</button>
      </div>
      <div class="ttt-board" id="ttt-board"></div>
      <div class="center">
        <div class="small" id="ttt-status">Turn: X</div>
        <button class="small-btn" id="reset-ttt" style="margin-top:10px">RESET</button>
      </div>
    </div>

    <div id="bone-screen" class="screen">
      <div class="top-row">
        <img src="https://i.imgur.com/V6qQgi1.png" class="icon-large" />
        <h2 style="margin:0">BONE RUSH</h2>
        <button class="small-btn" id="bone-home">MENU</button>
      </div>
      <div class="quiz-card center">
        <div class="word-display" id="bone-word">PRESS START</div>
        <input type="text" id="bone-input" class="answer-typed" placeholder="Type here..." autocomplete="off" />
        <div style="margin-top:10px;">
          <button class="small-btn" id="bone-start">START</button>
        </div>
        <div class="score-timer" style="margin-top:10px;">
          <div class="small">Bones: <span id="bone-score">0</span></div>
          <div class="small">Time: <span id="bone-timer">05:00</span></div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDEwADNCb_uNyeFkIgi5g03Pkqv3uXNpoQ",
        authDomain: "arkibo-arcade.firebaseapp.com",
        databaseURL: "https://arkibo-arcade-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "arkibo-arcade",
        storageBucket: "arkibo-arcade.firebasestorage.app",
        messagingSenderId: "647271681508",
        appId: "1:647271681508:web:5b51c957aaec76e7668bf1"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    /* --- AUTH LOGIC --- */
    let currentUser = null;
    let userPoints = 0;

    const nameInput = document.getElementById('username-input');
    const saveBtn = document.getElementById('save-user');

    function cleanFirebasePath(str) {
        if (!str) return "Player";
        return str.replace(/[.#$[\]{}:"]/g, "_");
    }

    async function initAuth() {
        let stored = localStorage.getItem('arkibo_user');
        if (stored) {
            currentUser = cleanFirebasePath(stored);
            loadUserData();
            showScreen('menu');
        } else {
            showScreen('auth-screen');
        }
    }

    saveBtn.onclick = async () => {
        const val = nameInput.value.trim();
        if (val.length < 3) return alert("Username too short!");
        currentUser = cleanFirebasePath(val);
        localStorage.setItem('arkibo_user', currentUser);
        const userRef = ref(db, 'users/' + currentUser);
        try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
                await set(userRef, { username: currentUser, points: 0 });
            }
            loadUserData();
            showScreen('menu');
        } catch (error) {
            alert("Connection error.");
        }
    };

    document.getElementById('logout-btn').onclick = () => {
        localStorage.removeItem('arkibo_user');
        location.reload();
    };

    function loadUserData() {
        if (!currentUser) return;
        document.getElementById('display-name').textContent = currentUser;
        const userRef = ref(db, 'users/' + currentUser);
        onValue(userRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                userPoints = data.points || 0;
                document.getElementById('display-points').textContent = userPoints;
            }
        });
    }

    async function addPoints(amount) {
        if (amount <= 0 || !currentUser) return;
        const userRef = ref(db, 'users/' + currentUser);
        await update(userRef, {
            points: userPoints + amount
        });
    }

    /* --- NAVIGATION --- */
    const screens = ['menu', 'quiz-screen', 'ttt-screen', 'bone-screen', 'auth-screen', 'lb-screen', 'match-screen', 'clicker-screen', 'chess-kibo-screen'];
    function showScreen(id) {
        screens.forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(id === 'lb-screen') loadLeaderboard();
        if(id === 'chess-kibo-screen') initChess();
    }

    document.getElementById('to-quiz').onclick = () => showScreen('quiz-screen');
    document.getElementById('to-ttt').onclick = () => showScreen('ttt-screen');
    document.getElementById('to-bone').onclick = () => showScreen('bone-screen');
    document.getElementById('to-match').onclick = () => showScreen('match-screen');
    document.getElementById('to-clicker').onclick = () => showScreen('clicker-screen');
    document.getElementById('to-chess-kibo').onclick = () => showScreen('chess-kibo-screen');
    document.getElementById('to-lb').onclick = () => showScreen('lb-screen');
    document.getElementById('lb-back').onclick = () => showScreen('menu');
    document.getElementById('quiz-back').onclick = () => showScreen('menu');
    document.getElementById('ttt-home').onclick = () => showScreen('menu');
    document.getElementById('bone-home').onclick = () => showScreen('menu');
    document.getElementById('match-home').onclick = () => showScreen('menu');
    document.getElementById('clicker-home').onclick = () => showScreen('menu');
    document.getElementById('chess-kibo-home').onclick = () => showScreen('menu');

    /* --- KIBO-CHESS LOGIC --- */
    let game = new Chess();
    const boardEl = document.getElementById('chess-board');
    let selectedSquare = null;

    const pieceMap = {
        'p': '‚ôü', 'r': '‚ôú', 'n': '‚ôû', 'b': '‚ôù', 'q': '‚ôõ', 'k': '‚ôö',
        'P': '‚ôô', 'R': '‚ôñ', 'N': '‚ôò', 'B': '‚ôó', 'Q': '‚ôï', 'K': '‚ôî'
    };

    function initChess() {
        game = new Chess();
        selectedSquare = null;
        renderBoard();
        updateStatus();
    }

    function renderBoard() {
        boardEl.innerHTML = '';
        const board = game.board();
        for (let i = 0; i < 8; i++) {
            for (let j = 0; j < 8; j++) {
                const square = document.createElement('div');
                const squareName = String.fromCharCode(97 + j) + (8 - i);
                square.className = `chess-square ${(i + j) % 2 === 0 ? 'light' : 'dark'}`;
                square.dataset.pos = squareName;
                
                const piece = board[i][j];
                if (piece) {
                    square.textContent = pieceMap[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                    square.style.color = piece.color === 'w' ? '#fff' : '#000';
                    square.style.textShadow = piece.color === 'w' ? '0 0 2px #000' : 'none';
                }

                if (selectedSquare === squareName) square.classList.add('selected');

                square.onclick = () => handleSquareClick(squareName);
                boardEl.appendChild(square);
            }
        }
    }

    async function handleSquareClick(pos) {
        if (game.game_over()) return;

        if (selectedSquare === pos) {
            selectedSquare = null;
            renderBoard();
            return;
        }

        const move = game.move({ from: selectedSquare, to: pos, promotion: 'q' });

        if (move) {
            selectedSquare = null;
            renderBoard();
            updateStatus();
            
            if (game.game_over()) {
                if (game.in_checkmate()) {
                    const winner = game.turn() === 'w' ? "Black" : "White";
                    alert(`CHECKMATE! ${winner} Wins!`);
                    await addPoints(50);
                } else {
                    alert("DRAW / STALEMATE!");
                    await addPoints(25);
                }
            }
        } else {
            const piece = game.get(pos);
            if (piece && piece.color === game.turn()) {
                selectedSquare = pos;
                renderBoard();
            }
        }
    }

    function updateStatus() {
        const turn = game.turn() === 'w' ? "WHITE" : "BLACK";
        document.getElementById('chess-kibo-status').textContent = game.in_check() ? `${turn} IN CHECK!` : `${turn}'S TURN`;
    }

    document.getElementById('chess-kibo-reset').onclick = initChess;

    /* --- TIC TAC TOE --- */
    let tttBoard = Array(9).fill(null);
    let tttActive = true;
    let tttPlayer = 'X';

    function initTTT() {
        const grid = document.getElementById('ttt-board');
        grid.innerHTML = '';
        tttBoard = Array(9).fill(null);
        tttActive = true;
        tttPlayer = 'X';
        document.getElementById('ttt-status').textContent = "Turn: X";
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.className = 'ttt-cell';
            cell.onclick = () => clickTTT(i, cell);
            grid.appendChild(cell);
        }
    }

    async function clickTTT(i, cell) {
        if (!tttActive || tttBoard[i]) return;
        tttBoard[i] = tttPlayer;
        cell.textContent = tttPlayer;
        if (checkTTTWin()) {
            document.getElementById('ttt-status').textContent = tttPlayer + " WINS!";
            tttActive = false;
            await addPoints(10);
            return;
        }
        if (!tttBoard.includes(null)) {
            document.getElementById('ttt-status').textContent = "DRAW!";
            tttActive = false;
            return;
        }
        tttPlayer = tttPlayer === 'X' ? 'O' : 'X';
        document.getElementById('ttt-status').textContent = "Turn: " + tttPlayer;
    }

    function checkTTTWin() {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        return wins.some(comb => comb.every(idx => tttBoard[idx] === tttPlayer));
    }

    document.getElementById('reset-ttt').onclick = initTTT;
    initTTT();

    /* --- MATCH-KIBO GAME --- */
    let matchIcons = ['üçé', 'üçé', '‚≠ê', '‚≠ê', 'üéÆ', 'üéÆ', 'üöÄ', 'üöÄ', 'üî•', 'üî•', 'üíé', 'üíé', 'üëª', 'üëª', 'üçÄ', 'üçÄ', 'üçÑ', 'üçÑ', 'üåç', 'üåç'];
    let flipped = [], matchCount = 0, matchTime = 120, matchActive = false, matchTimer;

    function initMatch() {
        const grid = document.getElementById('match-grid');
        grid.innerHTML = '';
        matchIcons.sort(() => Math.random() - 0.5);
        matchIcons.forEach((icon, i) => {
            const card = document.createElement('div');
            card.className = 'match-card';
            card.dataset.icon = icon;
            card.dataset.index = i;
            card.textContent = icon;
            card.onclick = () => flipMatch(card);
            grid.appendChild(card);
        });
    }

    function flipMatch(card) {
        if (!matchActive || flipped.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) return;
        card.classList.add('flipped');
        flipped.push(card);
        if (flipped.length === 2) {
            if (flipped[0].dataset.icon === flipped[1].dataset.icon) {
                flipped.forEach(c => c.classList.add('matched'));
                flipped = [];
                matchCount++;
                document.getElementById('match-count').textContent = matchCount;
                if (matchCount === 10) {
                    addPoints(10);
                    alert("Board Cleared! +10 Points");
                    matchCount = 0;
                    document.getElementById('match-count').textContent = "0";
                    initMatch();
                }
            } else {
                setTimeout(() => {
                    flipped.forEach(c => c.classList.remove('flipped'));
                    flipped = [];
                }, 700);
            }
        }
    }

    document.getElementById('match-start').onclick = () => {
        if (matchActive) return;
        matchActive = true; matchTime = 120; matchCount = 0;
        initMatch();
        matchTimer = setInterval(() => {
            matchTime--;
            document.getElementById('match-timer').textContent = matchTime;
            if (matchTime <= 0) {
                clearInterval(matchTimer);
                matchActive = false;
                alert("Game Over!");
            }
        }, 1000);
    };

    /* --- STAR CLICKER GAME --- */
    let clickScore = 0, clickTime = 30, clickActive = false, clickTimer;
    const star = document.getElementById('target-star');
    const area = document.getElementById('clicker-area');

    function moveStar() {
        const x = Math.random() * (area.clientWidth - 40);
        const y = Math.random() * (area.clientHeight - 40);
        star.style.left = x + 'px';
        star.style.top = y + 'px';
    }

    star.onclick = () => {
        if (!clickActive) return;
        clickScore++;
        document.getElementById('clicker-score').textContent = clickScore;
        moveStar();
    };

    document.getElementById('clicker-start').onclick = () => {
        if (clickActive) return;
        clickActive = true; clickScore = 0; clickTime = 30;
        document.getElementById('clicker-score').textContent = "0";
        star.style.display = 'block';
        moveStar();
        clickTimer = setInterval(() => {
            clickTime--;
            document.getElementById('clicker-timer').textContent = clickTime;
            if (clickTime <= 0) {
                clearInterval(clickTimer);
                clickActive = false;
                star.style.display = 'none';
                addPoints(Math.floor(clickScore / 2));
                alert("Time up! Earned " + Math.floor(clickScore / 2) + " stars.");
            }
        }, 1000);
    };

    /* --- LEADERBOARD --- */
    function loadLeaderboard() {
        const usersRef = ref(db, 'users');
        onValue(usersRef, (snapshot) => {
            const data = snapshot.val();
            const list = [];
            for (let id in data) list.push(data[id]);
            list.sort((a, b) => (b.points || 0) - (a.points || 0));
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = '';
            list.forEach((user, index) => {
                const tr = document.createElement('tr');
                if(user.username === currentUser) tr.className = 'my-row';
                tr.innerHTML = `<td>${index + 1}</td><td>${user.username || 'Anon'}</td><td>${user.points || 0}</td>`;
                tbody.appendChild(tr);
            });
        });
    }

    /* --- QUIZ LOGIC --- */
    const quizQuestions = [
      {q:"What is the capital city of Japan?", a:"Tokyo", choices:["Kyoto","Tokyo","Osaka","Hiroshima"]},
      {q:"Who painted the Mona Lisa?", a:"Leonardo da Vinci", choices:["Pablo Picasso","Leonardo da Vinci","Vincent van Gogh","Claude Monet"]},
      {q:"What is the chemical symbol for water?", a:"H2O", choices:["CO2","H2O","O2","NaCl"]}
    ];

    let qIndex = 0, qCorrect = 0, qTime = 300, qStarted = false, qMode = 'type', qTimer;

    function startQuiz() {
      qStarted = true; qIndex = 0; qCorrect = 0; qTime = 300;
      renderQ();
      qTimer = setInterval(() => {
        qTime--;
        const m = Math.floor(qTime/60), s = qTime%60;
        document.getElementById('quiz-timer').textContent = `${m}:${s<10?'0':''}${s}`;
        if(qTime<=0) { clearInterval(qTimer); alert("Time's up!"); showScreen('menu'); }
      }, 1000);
    }

    function renderQ() {
      const q = quizQuestions[qIndex];
      document.getElementById('quiz-question').textContent = q.q;
      const area = document.getElementById('quiz-interaction');
      area.innerHTML = '';
      if(qMode === 'type') {
        const inp = document.createElement('input');
        inp.type = 'text'; inp.className = 'answer-typed';
        inp.onchange = () => { if(inp.value.toLowerCase() === q.a.toLowerCase()) { qCorrect++; updateQuizScore(); } nextQ(); };
        area.appendChild(inp);
      } else {
        const box = document.createElement('div');
        box.className = 'choices';
        q.choices.forEach(c => {
          const b = document.createElement('button');
          b.className = 'choice-btn'; b.textContent = c;
          b.onclick = () => { if(c === q.a) qCorrect++; updateQuizScore(); nextQ(); };
          box.appendChild(b);
        });
        area.appendChild(box);
      }
    }

    function updateQuizScore() { document.getElementById('quiz-score').textContent = `${qCorrect} / ${quizQuestions.length}`; }
    function nextQ() { 
        qIndex++; 
        if(qIndex < quizQuestions.length) renderQ(); 
        else { 
            clearInterval(qTimer); 
            addPoints(qCorrect * 5);
            alert(`Quiz Done! Score: ${qCorrect}. Earned ${qCorrect*5} Stars.`); 
            showScreen('menu'); 
        } 
    }

    document.getElementById('quiz-start').onclick = startQuiz;

    /* --- BONE RUSH --- */
    const words = ["KIBO", "ARCADE", "CHESS", "CODING", "STARS", "BONE", "SMART", "ADVENTURE"];
    let bScore = 0, bTime = 60, bActive = false, bTimer;
    
    function startBone() {
      bActive = true; bScore = 0; bTime = 60;
      document.getElementById('bone-score').textContent = "0";
      nextWord();
      bTimer = setInterval(() => {
        bTime--;
        document.getElementById('bone-timer').textContent = bTime;
        if(bTime <= 0) { 
          clearInterval(bTimer); bActive = false; 
          addPoints(bScore);
          alert("Time's up! Earned " + bScore + " Stars."); 
        }
      }, 1000);
    }

    function nextWord() {
      const w = words[Math.floor(Math.random()*words.length)];
      document.getElementById('bone-word').textContent = w;
      document.getElementById('bone-input').value = '';
    }

    document.getElementById('bone-input').oninput = (e) => {
      if(!bActive) return;
      if(e.target.value.toUpperCase() === document.getElementById('bone-word').textContent) {
        bScore++; document.getElementById('bone-score').textContent = bScore;
        nextWord();
      }
    };
    document.getElementById('bone-start').onclick = startBone;

    initAuth();
  </script>
</body>
</html>
